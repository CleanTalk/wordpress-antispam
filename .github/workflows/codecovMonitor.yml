name: Codecov Patch Monitor

on:
  check_run:
    types: [completed]

jobs:
  notify:
    if: >
      github.event.check_run.name == 'codecov/patch' &&
      github.event.check_run.conclusion == 'failure' &&
      github.event.check_run.app.slug == 'codecov'
    runs-on: ubuntu-latest

    steps:
      - name: Send Matrix notification
        uses: Glomberg/matrix-messenger-action@master
        with:
          server: ${{ secrets.MATRIX_SERVER }}
          to: ${{ secrets.MATRIX_EXTERNSION_ROOM }}
          token: ${{ secrets.MATRIX_USER_TOKEN }}
          message: |
            ðŸš¨ Patch coverage below target!

            Repo: ${{ github.repository }}
            Branch: ${{ github.event.check_run.check_suite.head_branch }}
            Commit: ${{ github.event.check_run.head_sha }}

            Please increase test coverage.
