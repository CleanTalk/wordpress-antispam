name: PHPUnit, PHPCS, Psalm

on: # event list
  push: # on push to each of these branches
    branches:
      - dev
      - fix
      - beta
      - master
  pull_request:
    branches:
      - dev
      - master

env: # environment variables (available in any part of the action)
  PHP_VERSION: 7.4

jobs:
  build:
    name: PHPUnit, PHPCS, Psalm
    runs-on: ubuntu-22.04
    env:
      DB_CONNECTION: mysql
      DB_HOST: localhost
      DB_PORT: 3306
      DB_DATABASE: wordpress_test
      DB_USERNAME: root
      DB_PASSWORD: root

    steps:
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}

      - name: Run MySQL server
        run: sudo systemctl start mysql

      - name: Code Checkout
        uses: actions/checkout@v4

      - name: Make the script files executable
        run: chmod +x ./tests/wp-test-setup.sh

      - name: Install WP develop
        run: ./tests/wp-test-setup.sh wordpress_test root root localhost latest

      - name: Install Dependencies
        run: composer i

      - name: Check for library changes
        id: check-libraries
        run: |
          # Get changed files list (excluding composer.lock if exists)
          CHANGED_FILES=$(git status --porcelain | grep -v '^??' | awk '{print $2}' | grep -v '^composer\.lock$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "No library changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Library changes detected!"
            echo "Changed files:"
            echo "$CHANGED_FILES"
          
            # Generating output files list
            echo "changed_files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          
            # Generate HTML for Matrix
            HTML_LIST=$(echo "$CHANGED_FILES" | sed 's/^/<li>/;s/$/<\/li>/')
            echo "html_list<<EOF" >> $GITHUB_OUTPUT
            echo "<ul>$HTML_LIST</ul>" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          
            echo "has_changes=true" >> $GITHUB_OUTPUT
          
            # Output the result
            echo "Detailed git status:"
            git status
          fi

      - name: Notify about library changes in Matrix
        if: steps.check-libraries.outputs.has_changes == 'true'
        uses: Glomberg/matrix-messenger-action@master
        with:
          server: ${{ secrets.MATRIX_SERVER }}
          to: ${{ secrets.MATRIX_EXTERNSION_ROOM }}
          token: ${{ secrets.MATRIX_USER_TOKEN }}
          message: |
            üì¶ <strong>Library Changes Detected!</strong>
            
            Repository: <strong>${{ github.repository }}</strong>
            Commit by: <strong>${{ github.actor }}</strong>
            Branch: <strong>${{ github.ref_name }}</strong>
            
            ‚ö†Ô∏è One or more library files differ from the committed version.
            This may indicate that the libraries are not up-to-date.
            
            <strong>Changed files:</strong>
            ${{ steps.check-libraries.outputs.html_list }}
            
            <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}">View Commit</a> | 
            <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run</a>
            
            <em>Please update your composer.lock file if these changes are intentional.</em>

      - name: Running tests
        env:
          CLEANTALK_TEST_API_KEY: ${{ secrets.CLEANTALK_TEST_API_KEY }}
        run: composer test

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v5
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Matrix notify on failure
        if: failure()
        uses: Glomberg/matrix-messenger-action@master
        with:
          server: ${{ secrets.MATRIX_SERVER }}
          to: ${{ secrets.MATRIX_EXTERNSION_ROOM }}
          token: ${{ secrets.MATRIX_USER_TOKEN }}
          message: |
            Hi, <strong>${{ github.actor }}</strong>! Your commit for <strong>${{ github.repository }}</strong> 
            contains üíØ the best solution but it have to be fixed!
            <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">Auto-Tests (PHPUnit, PHPCS, Psalm)</a> build failed ‚õî!
